<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"  />
	<meta name="description" content="Kyle Halladay Game Development" />
	<meta name="keywords" content="life,code,software,development,games,ludology,indie" />
	<link rel="stylesheet" type="text/css" href="/css/default.css" />
	<link rel="stylesheet" type="text/css" href="/css/pretty_code.css" />
	<link rel="stylesheet" href="/css/highlight_default.css">
	<script src="/javascripts/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>

<title>Kyle Halladay - Toronto Game Developer</title>
</head>

<body>
	<div id="wrap">
		<div id="header">
			<p id="toplinks">
			</p>
			<h1><a href="/" class="logo"><div id="logo"></div></a><a href="/" class="logo">K</a><a href="/" class="logo">y</a><a href="/" class="logo">l</a><a href="/" class="logo">e</a> <a href="/" class="logo">H</a><a href="/" class="logo">a</a><a href="/" class="logo">l</a><a href="/" class="logo">l</a><a href="/" class="logo">a</a><a href="/" class="logo">d</a><a href="/" class="logo">a</a><a href="/" class="logo">y</a></h1>
			<div class="slogan"> 
					<a href="/" class="paleorange">Home</a> ||
					<a href="/archive.html" class="paleorange">Archive</a> ||
					<a href="/portfolio.html" class="paleorange">Games</a> ||
					<a href="/graphics.html" class="paleorange">Graphics</a> ||
					<a href="/aboutme.html" class="paleorange">About Me</a>
			</div>
	</div>
<div id="content">  
  <span class = "post_title">
<h2>A Simple Flow Map</h2>
</span>

<div id="post">
<br>
<p>Water effects have always seemed firmly in the realm of people who have much more graphics experience than me. When the need for a river effect presented itself in a project I’m working on, I was first in line to suggest that we buy a solution, rather than roll our own. However, after surveying what was out there, it became clear that all the options available required us to sacrifice more frame time than I was willing to give up for one effect.</p>

<p>Since I’m the only programmer on this specific project, this meant that building a river effect that satisfied our requirements fell to me. Since I’m much too stubborn to admit defeat without at least a quart of coffee drank and hours of sleep lost, it became time for water effects to become something that I did too.</p>

<p>We had already decided that we really liked how the plugin Flow looked, so anything that I built needed to match the appearance of the mobile shaders from there. Luckily, Flow had exposed me to the concept of a flow map, and I was pretty sure I could build my own fairly easily.</p>
<div align='center'>
	<img src='/images/post_images/2013-09-02/water-effect-comparison.png' /><br />
	<font size='2'>
		The right shows what the Flow plugin's basic mobile shader is, compared to mine on the left.
	</font>
</div>
<p><br /></p>

<p>Flow maps, if you’re unfamiliar with them, are textures used to dictate the direction that uv’s are scrolled across a model. Rather than simply scrolling every texture coord uniformly (creating a really lame effect), using a flow map is a relatively lightweight way to create winding, interesting water movement effects.</p>

<p>Traditionally, the scrolling texture coords are used to move a normal map across the surface of the water. The effect <a href="http://graphicsrunner.blogspot.ca/2010/08/water-using-flow-maps.html">looks really good</a>, but that was going to be far too heavy for what we needed, so I decided to copy Flow again, and simply scroll a secondary water texture overtop of the ground. The shader uses three textures, the ground, the water, and the flow map. The flow map is very simple: the red channel controls x movement, green channel controls y, and blue channel controls blending between the ground and water textures. #777777 is a 50% blend of ground and water that is not moving.</p>
<div align='center'>
	<img src='/images/post_images/2013-09-02/flow_map.png' /><br />
	<font size='2'>
	An example of a flow map used by this shader
	</font>
</div>
<p><br /></p>

<p>The only gotcha with this method is resetting the texture offset. To avoid the texcoords getting too distorted over time, the offset value needs to get reset to 0 regularly. This causes the texture to jump and looks terrible. I took a page out of the tutorial linked above, and fixed this by using 2 very similar (but different) offsets, which allow the texture to fade between the two, and hides the reset by never resetting the coord currently being shown.</p>

<p>Even cooler, because those offsets are uniform across a frame, keeping track of them (and performing any calculations that only involve them) can be moved to a script that executes once a frame and just sets those uniforms once. This isn’t usually something to write home about, but (at least in my experience) it’s uncommon to see scripts interacting with a material’s shader in Unity, and it ended up saving us 7ms a frame.</p>

<p>The end result of all this trouble is a flow map shader which is roughly 40% faster than the mobile shader included in flow, mostly due to ignoring all lights in the scene (we’re a mobile game, what lights?), and removing a bunch of colour multiply options. I’ve included the shader / script in the graphics section of the site, hopefully it can be useful :D</p>

<p>As always, send me a message <a href="http://twitter.com/khalladay">on Twitter</a> if you want to chat (especially about games or graphics).</p>
</div>


<div id="related">
  <h3>Recent Posts</h3>
  <ul class="posts">
    
      <li><span>24 Dec 2013</span> &raquo; <a href="/all/blog/2013/12/24/Ray-Sphere-Intersection.html">Ray-Sphere Intersection with Simple Math</a></li>
    
      <li><span>10 Nov 2013</span> &raquo; <a href="/all/blog/2013/11/10/Libpd-and-Unity.html">Combining Pure Data and Unity</a></li>
    
      <li><span>13 Oct 2013</span> &raquo; <a href="/all/blog/2013/10/13/Multi-Light-Diffuse.html">Writing Multi-Light Pixel Shaders in Unity</a></li>
    
      <li><span>28 Sep 2013</span> &raquo; <a href="/all/blog/2013/09/28/How-to-dissolve-effect.html">Making a Dissolve Effect with Surface Shaders</a></li>
    
      <li><span>02 Sep 2013</span> &raquo; <a href="/all/blog/2013/09/02/A-Simple-Flowmap.html">A Simple Flow Map</a></li>
    
      <li><span>13 Aug 2013</span> &raquo; <a href="/all/blog/2013/08/13/Coloured-Shadows.html">Multi Coloured Shadows In Unity</a></li>
    
      <li><span>20 Jul 2013</span> &raquo; <a href="/all/blog/2013/07/20/Down-The-Rabbit-Hole.html">Down The Rabbit Hole</a></li>
    
      <li><span>02 Jul 2013</span> &raquo; <a href="/all/blog/2013/07/02/Least-Resistance.html">Least Resistance</a></li>
    
      <li><span>16 Jun 2013</span> &raquo; <a href="/all/blog/2013/06/16/Its-Cool-In-The-Shader-Part4-Rim-Lighting.html">It&apos;s Cool In The Shader Part 4&#58; Rim Lighting</a></li>
    
      <li><span>10 Jun 2013</span> &raquo; <a href="/all/blog/2013/06/10/Its-Cool-In-The-Shader-Part3-Specular-Reflections.html">It&apos;s Cool In The Shader Part 3&#58; Specular Reflections</a></li>
    
  </ul>
</div>

<br>
<br>
</div>

<div id="footer">

	<a href="mailto:k.mj.halladay@gmail.com" class="footerlink">E-mail</a> |
    <a href="http://ca.linkedin.com/pub/kyle-halladay/2b/658/a14/" class="footerlink">LinkedIn</a> |
    <a href="http://twitter.com/khalladay" class="footerlink">Twitter</a>

<p>&copy; 2013 <a href="/aboutme.html" class="footerlink">Kyle Halladay</a>

</div>
</div>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40292745-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</body>
</html>

