<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kyle Halladay - Hooking Keyboard Input To Play Snake In Notepad.exe</title>
  <meta name="author" content="Kyle Halladay" />
  <meta name="description" content="I build shaders, renderers, games, and other stuff that's fun to stare at." />
  <link rel="canonical" href="http://kylehalladay.com/blog/2020/05/20/Hooking-Input-Snake-In-Notepad.html" />
  <meta name="keywords" content="life,code,software,development,games,graphics,shaders,indie" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Kyle Halladay" href="http://kylehalladay.com/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <a href="/">
    <img src="/logo.jpg" id="logo" alt="Blog logo" width="200" height="200"/>
  </a>
  <h2>I'm <a href="/">Kyle Halladay</a>.</h2>
  <div id="bio">
    <p>I do graphics and engine programming for games. </p>
    <p>I'm the author of <a href="https://www.amazon.com/Practical-Shader-Development-Fragment-Developers/dp/1484244567">Practical Shader Development</a>, which is all about learning to write shaders.</p>
    <p>Check out <a href="/archive.html">some other stuff I've written</a></p>
  </div>
  <div id="social">
    Want to say hi?
<div id="stalker">
  
  <a title="khalladay on Github" href="https://github.com/khalladay">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  

  
  <a title="khalladay on Twitter" href="https://twitter.com/khalladay">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  
  <a title="Kyle Halladay on LinkedIn" href="https://www.linkedin.com/in/kylehalladay">
    <i class="fa fa-linkedin-square"></i>
  </a>
  

  

  
  <a title="Kyle Halladay via Email" href="mailto:k.mj.halladay@gmail.com">
    <i class="fa fa-envelope-square"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/atom.xml">
    <i class="fa fa-rss-square"></i>
  </a>
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <topbar><div align="center"><h2><a href="/index.html" style="color:#000">KyleHalladay.com</a></h2></div>
      <div align="center" style="font-size:18px"><a href="/archive.html">Archive</a></div>
      <hr style="border-color:#000; margin:1em -0.25em;"></topbar>

      <p class="meta">

</p>

<div style="font-size:14px">20 May 2020</div>
<h1 class="title">Hooking Keyboard Input To Play Snake In Notepad.exe</h1> 

<div id="post">
  <style>
.collapsible {
  padding: 10px;
  background-color: #F5F5F5;
  border-style: solid;
  border-color: #333333;
  border-width: 2px;
}

.collapsewrapper2 {
	  padding: 0px 0px 18px 0px;
}

</style>

<p>This is second (and last) post about my quest to make a real-time game playable in stock Notepad.exe. In <a href="/blog/2020/05/20/Rendering-With-Notepad.html">the previous article</a>, I talked through using a quick and dirty memory scanner to get access to Notepad’s on screen text buffer (and build a ray tracer that rendered into it). In this post I’m going to talk about how I handled getting user input, and finally ended up at a fully playable Snake game in stock Notepad.</p>

<div align="center">
<img src="/images/post_images/2020-05-20/snake3.gif" />
<font size="2">The flickering problem from last time is still very not-fixed</font>
<br /><br />
</div>

<h2 id="babys-first-dll-injection">Baby’s First DLL Injection</h2>
<p>The title of this post gives away the fact that I ended using hooks to capture user input, but I originally thought I could do it with just DLL injection instead. I barely knew what DLL injection was but I knew it could cause things to happen in an already running process. This seemed like a decent place to start. As it turns out, you need to understand dll injection to work with hooks anyway, so it’s not a bad spot to start this blog post too.</p>

<p>I started by googling the hell out of “DLL injection,” and found <a href="http://deniable.org/windows/inject-all-the-things">this excellent article</a> that breaks down what DLL Injection is and has a great <a href="https://github.com/fdiskyou/injectAllTheThings">github repo</a> with examples of different ways to go about it. I didn’t have a clue about how I was going to use any of this capture keyboard input, but I figured I’d try to inject something simple into a running Notepad process anyway.</p>

<p>Based on the injection article I just linked, the easiest way to inject a dll seems to be:</p>

<ul>
  <li>Create a DLL that performs some action in dllmain when it is loaded</li>
  <li>Open a handle (“attach”) to a running process</li>
  <li>Allocate some memory in that process’ address space</li>
  <li>Use LoadLibrary to load that DLL into that process</li>
  <li>When it loads, that DLL does the stuff in dllmain</li>
</ul>

<p>Writing a DLL that does something in dllmain() is really easy if you aren’t doing a whole lot with it. I found later on that there’s a whole lot of stuff that you can’t do in dllmain (more info <a href="https://docs.microsoft.com/en-us/windows/win32/dlls/dllmain">here</a>), but for my first test project I just popped open a message box. The entire code for the DLL payload was just a few lines.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//a small dll payload that spawns a message box in whatever process loads the dll</span>
<span class="cp">#define WIN32_LEAN_AND_MEAN 
#include &lt;windows.h&gt;
</span>
<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">){</span>
    <span class="k">case</span> <span class="n">DLL_PROCESS_ATTACH</span><span class="p">:</span>
      <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Process attach!"</span><span class="p">,</span> <span class="s">"Woohoo"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>

<p>The tricky part, as you might imagine, was getting Notepad to load this in the first place. Just like the above payload, my injection code was almost entirely copied from the <a href="https://github.com/fdiskyou/injectAllTheThings">InjectAllTheThings repo</a> I linked above. Unlike the payload, it’s a lot longer. I’m including it here because if you’ve never seen how to do this before, I assume this will be more convenient than having to click a link to github, but I’m not going to dive into how it works because the article/repo I linked above can teach you about it a whole lot better than I can.</p>

<div class="collapsewrapper2">
<details class="collapsible">
    <summary>Full DLL Injection Code (click to expand)</summary>

    <div class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">//Injector_LoadLibrary is a dll injector that uses LoadLibraryA to inject a dll into a running process</span>
<span class="c1">// usage: Injector_LoadLibrary &lt;process name&gt; &lt;path to dll&gt; </span>

<span class="cp">#include &lt;stdio.h&gt;
#include &lt;Windows.h&gt;
#include &lt;TlHelp32.h&gt; //for PROCESSENTRY32, needs to be included after windows.h
</span>
<span class="kt">void</span> <span class="nf">printHelp</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"Injector_LoadLibrary</span><span class="se">\n</span><span class="s">Usage: Injector_LoadLibrary &lt;process name&gt; &lt;path to dll&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">createRemoteThread</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">processID</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">dllPath</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span>
		<span class="n">PROCESS_QUERY_INFORMATION</span> <span class="o">|</span> <span class="c1">//Needed to get a process' token</span>
		<span class="n">PROCESS_CREATE_THREAD</span> <span class="o">|</span>	  <span class="c1">//for obvious reasons</span>
		<span class="n">PROCESS_VM_OPERATION</span> <span class="o">|</span>	  <span class="c1">//required to perform operations on address space of process (like WriteProcessMemory)</span>
		<span class="n">PROCESS_VM_WRITE</span><span class="p">,</span>	<span class="c1">//required for WriteProcessMemory</span>
		<span class="n">FALSE</span><span class="p">,</span>			<span class="c1">//don't inherit handle</span>
		<span class="n">processID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not open process with pid: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">processID</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//once the process is open, we need to write the name of our dll to that process' memory</span>
	<span class="kt">size_t</span> <span class="n">dllPathLen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dllPath</span><span class="p">);</span>
	<span class="kt">void</span><span class="o">*</span> <span class="n">dllPathRemote</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span>
		<span class="n">handle</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="c1">//let the system decide where to allocate the memory</span>
		<span class="n">dllPathLen</span><span class="p">,</span>
		<span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="c1">//actually commit the virtual memory</span>
		<span class="n">PAGE_READWRITE</span><span class="p">);</span> <span class="c1">//mem access for committed page</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dllPathRemote</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not allocate %zd bytes in process with pid: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dllPathLen</span><span class="p">,</span> <span class="n">processID</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BOOL</span> <span class="n">writeSucceeded</span> <span class="o">=</span> <span class="n">WriteProcessMemory</span><span class="p">(</span>
		<span class="n">handle</span><span class="p">,</span>
		<span class="n">dllPathRemote</span><span class="p">,</span>
		<span class="n">dllPath</span><span class="p">,</span>
		<span class="n">dllPathLen</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writeSucceeded</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not write %zd bytes to process with pid %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dllPathLen</span><span class="p">,</span> <span class="n">processID</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//now get address of LoadLibraryW function inside Kernel32.dll</span>
	<span class="c1">//TEXT macro "Identifies a string as Unicode when UNICODE is defined by a preprocessor directive during compilation. Otherwise, ANSI string"</span>
	<span class="n">PTHREAD_START_ROUTINE</span> <span class="n">loadLibraryFunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandle</span><span class="p">(</span><span class="n">TEXT</span><span class="p">(</span><span class="s">"Kernel32.dll"</span><span class="p">)),</span> <span class="s">"LoadLibraryA"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">loadLibraryFunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not find LoadLibraryA function inside kernel32.dll</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="c1">//now create a thread in remote process that loads our target dll using LoadLibraryA</span>

	<span class="n">HANDLE</span> <span class="n">remoteThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span>
		<span class="n">handle</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="c1">//default thread security</span>
		<span class="mi">0</span><span class="p">,</span> <span class="c1">//stack size for thread</span>
		<span class="n">loadLibraryFunc</span><span class="p">,</span> <span class="c1">//pointer to start of thread function (for us, LoadLibraryA)</span>
		<span class="n">dllPathRemote</span><span class="p">,</span> <span class="c1">//pointer to variable being passed to thread function</span>
		<span class="mi">0</span><span class="p">,</span> <span class="c1">//0 means the thread runs immediately after creation</span>
		<span class="nb">NULL</span><span class="p">);</span> <span class="c1">//we don't care about getting back the thread identifier</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remoteThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Could not create remote thread.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">"Success! remote thread started in process %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">processID</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="c1">// Wait for the remote thread to terminate</span>
	<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">remoteThread</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>

	<span class="c1">//once we're done, free the memory we allocated in the remote process for the dllPathname, and shut down</span>
	<span class="n">VirtualFreeEx</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">dllPathRemote</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MEM_RELEASE</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">remoteThread</span><span class="p">);</span>
	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="nf">findPidByName</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HANDLE</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">PROCESSENTRY32</span> <span class="n">singleProcess</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span> <span class="c1">//takes a snapshot of specified processes</span>
		<span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="c1">//get all processes</span>
		<span class="mi">0</span><span class="p">);</span> <span class="c1">//ignored for SNAPPROCESS</span>

	<span class="n">singleProcess</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">singleProcess</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">DWORD</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">singleProcess</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">;</span>
			<span class="n">printf</span><span class="p">(</span><span class="s">"PID Found: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
			<span class="n">CloseHandle</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">singleProcess</span><span class="p">));</span>

	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printHelp</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">createRemoteThread</span><span class="p">(</span><span class="n">findPidByName</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

  </details></div>

<p>This was enough to get a message box popping up in a running instance of Notepad, which was super cool. Unfortunately I realized pretty much immediately after I got this working that I had no idea how to go from popping a message box to using this to actually change Notepad’s behaviour.</p>

<div align="center">
<img src="/images/post_images/2020-05-20/message_popup.PNG" />
<font size="2">Celebrate the little things</font>
<br /><br />
</div>

<h2 id="lets-try-hooking">Let’s Try Hooking!</h2>
<p>My message box app could make something new happen in another process, but I actually needed to be able to <em>change</em> the behaviour of the target process. I had heard vaguely about api hooking before, and my limited understanding of it was that it allowed you to either replace existing code paths, or add additional functionality to them. This seemed roughly in line with what I wanted, so I dove down this rabbit hole next.</p>

<p>Googling for how hooking works was less straightforward than dll injection, mostly because hooking is much more complicated. I eventually realized that as long as I wanted to change a program’s reponse to a Windows system message, I could bypass a lot of this complexity and use a Win32 hook. Given that keyboard input is sent to Windows processes via WH_KEYBOARD messages, I was in luck.</p>

<p>The <a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/hooks">MDSN page for hooks</a> provides some basic information about how these types of hooks work, but the general idea is like this (note: I’m a super beginner at all of this so take everything I say with a grain of salt):</p>

<ul>
  <li>Windows apps (and individual Win32 controls) receive events from the OS via system messages.</li>
  <li>Before these messages are passed to the message handling function for a given Win32 window, it first gets passed to that system message’s “hook chain,” which is a list of functions that perform some action in response to that event type before the window has a chance to respond.</li>
  <li>Each hook function is responsible for passing the system message information to the next item in the hook chain</li>
  <li>If a hook function <em>doesn’t</em> call the next function in the hook chain, the message can be lost before the window ever gets a chance to respond to it.</li>
</ul>

<p>Given this information, it seemed reasonable to try to intercept the keyboard events sent to Notepad by creating a hook function which intentionally didn’t call the next function in the hook chain. After persuing the msdn docs page about <a href="https://docs.microsoft.com/en-us/windows/win32/winmsg/using-hooks">using hooks</a>, I figured out that I was going to need to install a WH_KEYBOARD hook into Notepad’s Edit control.</p>

<p>The docs also point out that if you want to install a hook in a process other than your own, what you’re really doing is a form of dll injection. You need to place the hook function in a dll, and use SetWindowsHookEx() to load that dll’s code into the target application.</p>

<p>So with all that in mind, I put on my robe and wizard hat and got to work.</p>

<h2 id="writing-a-simple-hook-payload">Writing a Simple Hook Payload</h2>

<p>I started off by just trying to prevent Notepad from receiving keyboard input at all. All I needed to do for this was to hook the WH_KEYBOARD and then <em>not</em> call the next hook in the hook chain, which seemed like an easy place to start. To write a hook function for WH_KEYBOARD, all you need to do is make sure to match the function signature of <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/legacy/ms644984(v=vs.85)">KeyboardProc()</a>. Given that I needed this function to do basically nothing, this was pretty easy:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define WIN32_LEAN_AND_MEAN 
#include &lt;windows.h&gt;
#include "inject_payload_disablekeyinput.h"
</span>
<span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">KeyboardProc</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="n">WINAPI</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpvReserved</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<h2 id="installing-a-hook-in-notepadexe">Installing A Hook In Notepad.exe</h2>
<p>The code for installing a windows hook is very straightforward (and shown below).</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">bool</span> <span class="nf">installRemoteHook</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">threadId</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">hookDLL</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HMODULE</span> <span class="n">hookLib</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="n">hookDLL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hookLib</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	
	<span class="n">HOOKPROC</span> <span class="n">hookFunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">HOOKPROC</span><span class="p">)</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hookLib</span><span class="p">,</span> <span class="s">"KeyboardProc"</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hookFunc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	
	<span class="n">SetWindowsHookEx</span><span class="p">(</span><span class="n">WH_KEYBOARD</span><span class="p">,</span> <span class="n">hookFunc</span><span class="p">,</span> <span class="n">hookLib</span><span class="p">,</span> <span class="n">threadId</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>The threadId function argument is used to install the hook only for Notepad’s Edit control (otherwise it becomes a global hook). Getting the thread id is juat a matter of calling <a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getwindowthreadprocessid">GetWindowThreadProcessId()</a> on the HWND for the Edit control. You can get the HWND with the GetWindowForProcessAndClassName() function from <a href="/blog/2020/05/20/Rendering-With-Notepad.html">my last post</a>. Here’s that function again:</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">HWND</span> <span class="nf">GetWindowForProcessAndClassName</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">pid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">className</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">HWND</span> <span class="n">curWnd</span> <span class="o">=</span> <span class="n">GetTopWindow</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//0 arg means to get the window at the top of the Z order</span>
  <span class="kt">char</span> <span class="n">classNameBuf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">curWnd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
    <span class="n">DWORD</span> <span class="n">curPid</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwThreadId</span> <span class="o">=</span> <span class="n">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">curWnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curPid</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">curPid</span> <span class="o">==</span> <span class="n">pid</span><span class="p">){</span>
      <span class="n">GetClassName</span><span class="p">(</span><span class="n">curWnd</span><span class="p">,</span> <span class="n">classNameBuf</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">className</span><span class="p">,</span> <span class="n">classNameBuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">curWnd</span><span class="p">;</span>

      <span class="n">HWND</span> <span class="n">childWindow</span> <span class="o">=</span> <span class="n">FindWindowEx</span><span class="p">(</span><span class="n">curWnd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">className</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">childWindow</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">childWindow</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">curWnd</span> <span class="o">=</span> <span class="n">GetNextWindow</span><span class="p">(</span><span class="n">curWnd</span><span class="p">,</span> <span class="n">GW_HWNDNEXT</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>One thing to note about the installRemoteHook() function is that because it gets the function pointer for the callback with GetProcAddress(), the compiled name of the hook callback is important. This meant that I needed to make sure that to export that function using “extern C” to prevent the compiler from mangling the function name.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#pragma once
</span><span class="k">extern</span> <span class="s">"C"</span>
<span class="p">{</span>
  <span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="n">KeyboardProc</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>

<p>If you want to see what all of this looks like in pactice, the <a href="https://github.com/khalladay/render-with-notepad">github repo</a> for this blog post has a proof of concept hooking app uses the hook payload described above to disable key input to an instance of Notepad.</p>

<h2 id="redirecting-keyboard-input-to-a-different-process">Redirecting Keyboard Input to a Different Process</h2>
<p>Simply preventing Notepad from getting keyboard input was cool and all, but it was a far cry from being able to redirect that output to a game. What I wanted to be able to do was both prevent Notepad from getting keyboard input (so that the user couldn’t type characters and mess up what I was rendering), <em>and</em> redirect that key input to the process I was using to control my game logic.</p>

<p>Redirecting the key input to a different process wasn’t much more difficult than preventing key input. I just copy/pasted the code for disabling key input and made the following changes:</p>

<ul>
  <li>The Hooking app opens up a socket, and starts listening for messages before installing the hook</li>
  <li>In the payload, when the first keyboard message is intercepted, the payload creates a client socket and connects to the Injector app</li>
  <li>Then, whenever a keyboard message is seen by the hook callback, it sends that char code to the Injector app via this client socket</li>
</ul>

<p>I’m not going to walk through how to set up windows sockets (but all the code for doing so is on the <a href="https://github.com/khalladay/render-with-notepad">github page</a> for this project). Instead, I just want to share the hook payload that I used to make this all happen.</p>

<div class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">SOCKET</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">INVALID_SOCKET</span><span class="p">;</span>

<span class="n">LRESULT</span> <span class="n">CALLBACK</span> <span class="nf">KeyboardProc</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">WPARAM</span> <span class="n">wParam</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">lParam</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">BUFLEN</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">sendBuf</span><span class="p">[</span><span class="n">BUFLEN</span><span class="p">];</span>
  <span class="n">memset</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">BUFLEN</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="n">INVALID_SOCKET</span><span class="p">){</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">CreateClientSocket</span><span class="p">(</span><span class="s">"localhost"</span><span class="p">,</span> <span class="s">"1337"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">isKeyDown</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lParam</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isKeyDown</span><span class="p">){</span>
    <span class="n">_itoa_s</span><span class="o">&lt;</span><span class="mi">512</span><span class="o">&gt;</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">wParam</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sendBuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">sendBuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>

<p>Extracting the key state from the lparam was a little weird, but it seemed like the best way to get at that information. If you wanted to write a more robust input handling hook, you’d probably care about more of the data in that parameter than I did, but this was enough for getting WASD.</p>

<p>Once this was working, it was a very small jump from there to a working real time game.</p>

<h2 id="snake-finally">Snake, Finally!</h2>
<p>So yeah, the fruit of all this labor isn’t super exciting. I made Snake. It lends itself super well to ascii graphics (even if the fact that characters are taller than they are wide is a bit annoying), and I already had the gameplay logic written from a <a href="/blog/2019/12/04/Recreating-A-Dirty-Gamedev-Hack.html">couple posts ago</a>.</p>

<p>There’s not really much interesting to say about implementing Snake, and I’ve already talked through everything else, so I’m going to end things off with another gif of me playing snake in a hijacked Notepad.exe window. I hope you enjoyed the process of getting here as much as I did, because the end product is (as promised) super dumb.</p>

<div align="center">
<img src="/images/post_images/2020-05-20/snake.gif" />
<font size="2">It's a terrible quality gif... but you get the idea</font>
<br /><br />
</div>

</div>

<div id="related">
  <h3>Recent Posts</h3>
  <ul class="posts">
    
    <li>
      <span>14 Jul 2021 &raquo;</span> <a href="/blog/2021/07/14/Dll-Search-Order-Hijacking-For-PostProcess-Injection.html">Hooking and Hijacking DirectX 11 Functions In Skyrim</a>
    </li>
    
    <li>
      <span>13 Nov 2020 &raquo;</span> <a href="/blog/2020/11/13/Hooking-By-Example.html">X64 Function Hooking by Example</a>
    </li>
    
    <li>
      <span>20 May 2020 &raquo;</span> <a href="/blog/2020/05/20/Rendering-With-Notepad.html">Ray Tracing In Notepad.exe At 30 FPS</a>
    </li>
    
    <li>
      <span>20 May 2020 &raquo;</span> <a href="/blog/2020/05/20/Hooking-Input-Snake-In-Notepad.html">Hooking Keyboard Input To Play Snake In Notepad.exe</a>
    </li>
    
  </ul>
</div>


      <div class="footer">
        <div class="disclaimer">
  
  <p>
    The postings on this site are my own and don't necessarily represent my 
    employer’s positions, strategies or opinions.
  </p>
  

  <p>
    © Kyle Halladay, 2021 &mdash; built with <a href="http://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/swanson/lagom">Lagom theme</a>
  </p>
</div>
      </div>
    </div>
  </div>

</body>
</html>
