<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kyle Halladay - A Simple Flow Map</title>
  <meta name="author" content="Kyle Halladay" />
  <meta name="description" content="My thoughts about game and graphics programming" />
  <link rel="canonical" href="http://kylehalladay.com/blog/2013/09/02/A-Simple-Flowmap.html" />
  <meta name="keywords" content="life,code,software,development,games,graphics,shaders,indie" />

  <link href="//fonts.googleapis.com/css?family=Open+Sans:600,800" rel="stylesheet" type="text/css">
  <link rel="shortcut icon" href="/favicon.png">
  <link rel="alternate" type="application/rss+xml" title="Kyle Halladay" href="http://kylehalladay.com/atom.xml" />

  <link rel="stylesheet" href="/assets/css/all.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="four columns sidebar">
      <nav>
  <h1>Hi.</h1>
  <a href="/">
    <img src="/logo.png" id="logo" alt="Blog logo"/>
  </a>
  <h2>I'm <a href="/">Kyle Halladay</a>.</h2>
  <div id="bio">
    <p>I make games, renderers, shaders, and other stuff thats fun to stare at.</p>
    <p>Check out <a href="/archive.html">Some other stuff I've written</a></p>
  </div>
  <div id="social">
    Want to say hi?
<div id="stalker">
  
  <a title="khalladay on Github" href="https://github.com/khalladay">
    <i class="fa fa-github-square"></i>
  </a>
  

  

  

  

  

  
  <a title="khalladay on Twitter" href="https://twitter.com/khalladay">
    <i class="fa fa-twitter-square"></i>
  </a>
  

  

  

  
  <a title="Kyle Halladay on LinkedIn" href="https://www.linkedin.com/in/kylehalladay">
    <i class="fa fa-linkedin-square"></i>
  </a>
  

  

  
  <a title="Kyle Halladay via Email" href="mailto:k.mj.halladay@gmail.com">
    <i class="fa fa-envelope-square"></i>
  </a>
  

  <a title="RSS feed" id="rss" href="/atom.xml">
    <i class="fa fa-rss-square"></i>
  </a>
</div>

  </div>
</nav>

    </div>

    <div class="eleven columns content">
      <topbar><div align="center"><h2><a href="/index.html" style="color:#000">KyleHalladay.com</a></h2></div>
      <div align="center" style="font-size:18px"><a href="/archive.html">Archive</a> | <a href="/portfolio.html">Portfolio</a> | <a href="/graphics.html">Shaders</a></div>
      <hr style="border-color:#000; margin:1em -0.25em;"></topbar>

      <p class="meta">
 
</p>

<h1 class="title">A Simple Flow Map</h1>

<div id="post">
  <p>Water effects have always seemed firmly in the realm of people who have much more graphics experience than me. When the need for a river effect presented itself in a project I’m working on, I was first in line to suggest that we buy a solution, rather than roll our own. However, after surveying what was out there, it became clear that all the options available required us to sacrifice more frame time than I was willing to give up for one effect. </p>

<p>Since I’m the only programmer on this specific project, this meant that building a river effect that satisfied our requirements fell to me. Since I’m much too stubborn to admit defeat without at least a quart of coffee drank and hours of sleep lost, it became time for water effects to become something that I did too.</p>

<p>We had already decided that we really liked how the plugin Flow looked, so anything that I built needed to match the appearance of the mobile shaders from there. Luckily, Flow had exposed me to the concept of a flow map, and I was pretty sure I could build my own fairly easily. </p>

<div align="center">
	<img src="/images/post_images/2013-09-02/water-effect-comparison.png" /><br />
	<font size="2">
		The right shows what the Flow plugin's basic mobile shader is, compared to mine on the left.
	</font>
</div>
<p><br /></p>

<p>Flow maps, if you’re unfamiliar with them, are textures used to dictate the direction that uv’s are scrolled across a model. Rather than simply scrolling every texture coord uniformly (creating a really lame effect), using a flow map is a relatively lightweight way to create winding, interesting water movement effects. </p>

<p>Traditionally, the scrolling texture coords are used to move a normal map across the surface of the water. The effect <a href="http://graphicsrunner.blogspot.ca/2010/08/water-using-flow-maps.html">looks really good</a>, but that was going to be far too heavy for what we needed, so I decided to copy Flow again, and simply scroll a secondary water texture overtop of the ground. The shader uses three textures, the ground, the water, and the flow map. The flow map is very simple: the red channel controls x movement, green channel controls y, and blue channel controls blending between the ground and water textures. #777777 is a 50% blend of ground and water that is not moving. </p>

<div align="center">
	<img src="/images/post_images/2013-09-02/flow_map.png" /><br />
	<font size="2">
	An example of a flow map used by this shader
	</font>
</div>
<p><br /></p>

<p>The only gotcha with this method is resetting the texture offset. To avoid the texcoords getting too distorted over time, the offset value needs to get reset to 0 regularly. This causes the texture to jump and looks terrible. I took a page out of the tutorial linked above, and fixed this by using 2 very similar (but different) offsets, which allow the texture to fade between the two, and hides the reset by never resetting the coord currently being shown. </p>

<p>Even cooler, because those offsets are uniform across a frame, keeping track of them (and performing any calculations that only involve them) can be moved to a script that executes once a frame and just sets those uniforms once. This isn’t usually something to write home about, but (at least in my experience) it’s uncommon to see scripts interacting with a material’s shader in Unity, and it ended up saving us 7ms a frame. </p>

<p>The end result of all this trouble is a flow map shader which is roughly 40% faster than the mobile shader included in flow, mostly due to ignoring all lights in the scene (we’re a mobile game, what lights?), and removing a bunch of colour multiply options. I’ve included the shader / script in the graphics section of the site, hopefully it can be useful :D </p>

<p>As always, send me a message <a href="http://twitter.com/khalladay">on Twitter</a> if you want to chat (especially about games or graphics).</p>

</div>

<div id="related">
  <h3>More Posts</h3>
  <ul class="posts">
    
    <li>
      <span>16 May 2014 &raquo;</span> <a href="/blog/tutorial/bestof/2014/05/16/Coloured-Shadows-In-Unity.html">Colouring Shadows in Unity</a>
    </li>
    
    <li>
      <span>12 Jan 2014 &raquo;</span> <a href="/blog/tutorial/bestof/2014/01/12/Runtime-Shader-Compilation-Unity.html">Creating GLSL Shaders at Runtime in Unity3D</a>
    </li>
    
    <li>
      <span>06 Jan 2014 &raquo;</span> <a href="/blog/tutorial/bestof/2014/01/06/Hacking-My-Attention-Span.html">Automating SelfControl in OS X Mavericks</a>
    </li>
    
  </ul>
</div>


      <div class="footer">
        <div class="disclaimer">
  
  <p>
    The postings on this site are my own and don't necessarily represent my 
    employer’s positions, strategies or opinions.
  </p>
  

  <p>
    © Kyle Halladay, 2014 &mdash; built with <a href="http://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/swanson/lagom">Lagom theme</a>
  </p>
</div>
      </div>
    </div>
  </div>


<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-40292745-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

</body>
</html>
